---
title: "Model1_Model4"
format: html
editor: visual
---

## Model 1 and Model 4

```{r}
library(dplyr)
library(stringr)
library(caret)
library(randomForest)

library(ggplot2)
library(scales)
library(maps)
library(mapdata)
library(sf)
library(cowplot)


# LOAD DATA
df <- read.csv("../data/Nutrition.csv", stringsAsFactors = FALSE)


# QUESTION 1:
# What is the association between median income and the mean BMI value (Data_Value) across states after controlling for sex and race/ethnicity?


# 1A. Compute mean obesity (%) per state
state_obesity <- df %>%
  filter(Topic == "Obesity / Weight Status",
         StratificationCategory1 == "Total") %>%
  group_by(LocationAbbr) %>%
  summarize(mean_obesity = mean(Data_Value, na.rm = TRUE))


# 1B. Map income categories → numeric midpoints
income_midpoints <- c(
  "Less than $15,000" = 12500,
  "$15,000 - $24,999" = 20000,
  "$25,000 - $34,999" = 30000,
  "$35,000 - $49,999" = 42500,
  "$50,000 - $74,999" = 62500,
  "$75,000 or greater" = 87500,
  "Data not reported" = NA
)

income_df <- df %>%
  filter(StratificationCategory1 == "Income") %>%
  mutate(income_num = income_midpoints[Stratification1]) %>%
  group_by(LocationAbbr) %>%
  summarize(state_median_income = median(income_num, na.rm = TRUE))


# 1C. Physical inactivity: % reporting no leisure-time activity
state_inactivity <- df %>%
  filter(Topic == "Physical Activity - Behavior",
         StratificationCategory1 == "Total",
         str_detect(Question, regex("no leisure-time", ignore_case = TRUE))) %>%
  group_by(LocationAbbr) %>%
  summarize(pct_no_leisure_activity = mean(Data_Value, na.rm = TRUE))


# 1D. Merge features into a single state-level dataset
states <- state_obesity %>%
  left_join(income_df, by = "LocationAbbr") %>%
  left_join(state_inactivity, by = "LocationAbbr") %>%
  drop_na()


# 1E. Regression Models
model1 <- lm(mean_obesity ~ state_median_income, data = states)
model2 <- lm(mean_obesity ~ state_median_income + pct_no_leisure_activity, data = states)

cat("QUESTION 1: Regression Results\n")

cat("=== MODEL 1: Obesity ~ Median Income ===\n")
print(summary(model1))

cat("\n=== MODEL 2: Obesity ~ Income + Physical Inactivity ===\n")
print(summary(model2))



# QUESTION 4:
#Can we classify whether a respondent is obese (BMI ≥ 30) or not obese, based on physical activity levels, education, income, and race/ethnicity?


# 4A. Create binary high-obesity label for states
median_obesity <- median(states$mean_obesity)
states$high_obesity <- ifelse(states$mean_obesity >= median_obesity, 1, 0)


# 4B. Prepare predictors and model training
predictors <- states %>%
  select(state_median_income, pct_no_leisure_activity)

set.seed(42)

# Logistic Regression (caret)
logreg_model <- train(
  x = predictors,
  y = factor(states$high_obesity),
  method = "glm",
  family = "binomial",
  trControl = trainControl(method = "cv", number = 5)
)

# Random Forest
rf_model <- train(
  x = predictors,
  y = factor(states$high_obesity),
  method = "rf",
  trControl = trainControl(method = "cv", number = 5)
)

cat("QUESTION 4: Classifier Results\n")

cat("Logistic Regression Accuracy (CV): ",
    max(logreg_model$results$Accuracy), "\n")

cat("Random Forest Accuracy (CV): ",
    max(rf_model$results$Accuracy), "\n")




# VISUALIZATION SECTION (ggplot2)


# Convert state abbreviations → full lowercase names for mapping
abb_to_name <- tibble(
  LocationAbbr = c(state.abb, "DC"),
  state_name = tolower(c(state.name, "District of Columbia"))
)

states_plot_df <- states %>%
  left_join(abb_to_name, by = "LocationAbbr") %>%
  filter(!is.na(state_name))

us_states_map <- map_data("state")


#1. SCATTERPLOTS + REGRESSION LINES 

p1 <- ggplot(states_plot_df, aes(x = state_median_income, y = mean_obesity)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_continuous(labels = dollar_format()) +
  labs(
    title = "Obesity (%) vs Median Income",
    x = "Median Income (USD)",
    y = "Mean Obesity (%)"
  ) +
  theme_minimal()

p2 <- ggplot(states_plot_df, aes(x = pct_no_leisure_activity, y = mean_obesity)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Obesity (%) vs Physical Inactivity (%)",
    x = "No Leisure-Time Physical Activity (%)",
    y = "Mean Obesity (%)"
  ) +
  theme_minimal()

print(p1)
print(p2)



# 2. CHOROPLETH MAPS 

# Obesity map
map_obesity <- us_states_map %>%
  left_join(states_plot_df %>% select(state_name, mean_obesity),
            by = c("region" = "state_name"))

p_map_obesity <- ggplot(map_obesity, aes(long, lat, group = group, fill = mean_obesity)) +
  geom_polygon(color = "white") +
  coord_fixed(1.3) +
  scale_fill_viridis_c(name = "Obesity (%)") +
  labs(title = "Mean Obesity (%) by State") +
  theme_void()

# Income map
map_income <- us_states_map %>%
  left_join(states_plot_df %>% select(state_name, state_median_income),
            by = c("region" = "state_name"))

p_map_income <- ggplot(map_income, aes(long, lat, group = group, fill = state_median_income)) +
  geom_polygon(color = "white") +
  coord_fixed(1.3) +
  scale_fill_viridis_c(name = "Median Income ($)", labels = dollar_format()) +
  labs(title = "Median Income by State") +
  theme_void()

# Inactivity map
map_inactivity <- us_states_map %>%
  left_join(states_plot_df %>% select(state_name, pct_no_leisure_activity),
            by = c("region" = "state_name"))

p_map_inactivity <- ggplot(map_inactivity, aes(long, lat, group = group, fill = pct_no_leisure_activity)) +
  geom_polygon(color = "white") +
  coord_fixed(1.3) +
  scale_fill_viridis_c(name = "% No Leisure PA") +
  labs(title = "Physical Inactivity (%) by State") +
  theme_void()

print(p_map_obesity)
print(p_map_income)
print(p_map_inactivity)

```
